#!/bin/bash
set -e

registry=$1
build_tag=$2
latest_tag=$3
sql_seed_dump_URL=$4
dist_SQL_only_URL=$5

# thx to https://stackoverflow.com/a/13864829
if [ -z ${4+x} ];
then sqlSeedDumpParam="";
else sqlSeedDumpParam="-e URL_SEED_DUMP=$4";
fi

if [ -z ${5+x} ];
then metasfreshDistSQLParam="";
else metasfreshDistSQLParam="-e URL_MIGRATION_SCRIPTS_PACKAGE=$5";
fi

dir=$(dirname "$0")

cd $dir

# create the init-image
docker build ./db-init -t metasfresh/metasfresh-db_init:${build_tag}

# run the init image; it will start the postgresql server, prepare the metasfresh database and stop
docker run --name db_init_container${build_tag} \
${sqlSeedDumpParam} \
${metasfreshDistSQLParam} \
metasfresh/metasfresh-db_init:${build_tag}

# thx to https://github.com/moby/moby/issues/25245#issuecomment-365980572
mkdir -p ${dir}/db/postgresql_data_dir
docker cp db_init_container${build_tag}:/var/lib/postgresql/data/ ${dir}/db/postgresql_data_dir/

# create the actual database image
docker build --build-arg CACHEBUST=$(date "+%Y-%m-%d") ./db -t metasfresh/metasfresh-db:${build_tag}

docker tag metasfresh/metasfresh-db:${build_tag} ${registry}/metasfresh/metasfresh-db:${build_tag}
docker push ${registry}/metasfresh/metasfresh-db:${build_tag}

docker tag ${registry}/metasfresh/metasfresh-db:${build_tag} ${registry}/metasfresh/metasfresh-db:${latest_tag}
docker push ${registry}/metasfresh/metasfresh-db:${latest_tag}

# write
echo "# File generated by build_db.sh script"
echo "build_image=${registry}/metasfresh/metasfresh-db:${build_tag}" >> build_sb_result_dockerimages.properties
echo "latest_image=${registry}/metasfresh/metasfresh-db:${latest_tag}" >> build_sb_result_dockerimages.properties

# clean up
#docker rm db_init_container${build_tag}
#docker rmi metasfresh/metasfresh-db_init:${build_tag}
#docker rmi metasfresh/metasfresh-db:${build_tag}
